<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Historique des demandes - PMN BANK</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-slate-50 min-h-screen font-sans">
    <nav class="bg-[#00707b] text-white shadow-md sticky top-0 z-50">
      <div
        class="max-w-6xl mx-auto px-6 h-16 flex justify-between items-center"
      >
        <a href="/" class="font-extrabold">PMN-BANK</a>
        <div class="space-x-8 text-sm uppercase font-semibold hidden md:flex">
          <a href="/" class="hover:text-blue-200">Accueil</a>
          <a href="/result" class="hover:text-blue-200">Simulation</a>
          <a href="/historique" class="border-b-2 border-white pb-1"
            >Historique</a
          >
        </div>
      </div>
    </nav>

    <div class="max-w-7xl mx-auto py-10 px-4">
      <h1 class="text-3xl font-extrabold text-gray-800 mb-6">
        Historique des demandes de crédit
      </h1>

      <div class="overflow-x-auto bg-white shadow-xl rounded-2xl">
        <table class="min-w-full border-collapse text-sm">
          <thead class="bg-[#00707b] text-white">
            <tr>
              <th class="p-4 text-left">ID</th>
              <th class="p-4 text-left">Décision</th>
              <th class="p-4 text-left">Score (%)</th>
              <th class="p-4 text-left">Données saisis</th>
              <th class="p-4 text-left">Facteurs défavorables</th>
            </tr>
          </thead>
          <tbody id="history-table" class="divide-y"></tbody>
        </table>
      </div>
    </div>

    <script>
      // Correspondance entre les noms techniques du modèle et les noms lisibles
      const MODEL_TO_HUMAN = {
        var_174: "Âge",
        var_133: "Revenus mensuels",
        var_53: "Apport personnel",
        var_34: "Ancienneté CDI",
        var_99: "Crédits en cours",
        var_165: "Durée du prêt",
        var_190: "Charges mensuelles",
        var_6: "Revenus secondaires",
        var_22: "Ancienneté bancaire",
        var_12: "Valeur du patrimoine",
        var_146: "Personnes à charge",
        var_76: "Virements épargne",
        var_166: "Solde moyen mensuel",
        var_78: "Abonnements",
        var_21: "Crédits remboursés",
      };

      async function loadHistory() {
        const response = await fetch("/api/historique");
        const data = await response.json();
        console.log(data);

        const tbody = document.getElementById("history-table");
        tbody.innerHTML = "";

        data.history.forEach((item, index) => {
          const decisionColor =
            item.decision === "accord"
              ? "text-green-700 font-bold"
              : "text-red-700 font-bold";

          const inputsList = Object.entries(item.inputs)
            .map(
              ([key, value]) =>
                `<li><strong>${key}</strong> : ${
                  value !== null ? value : "N/A"
                }</li>`
            )
            .join("");

          // Logique de conversion des facteurs négatifs
          const negatives =
            item.decision === "refus" && item.top_negative_features
              ? `<ul class="list-disc pl-5 text-red-700">
                ${item.top_negative_features
                  .map((f) => {
                    // On cherche le nom réel dans le dictionnaire, sinon on garde le nom technique
                    const realName = MODEL_TO_HUMAN[f.feature] || f.feature;
                    return `<li>${realName} (impact ${f.impact.toFixed(
                      2
                    )})</li>`;
                  })
                  .join("")}
              </ul>`
              : `<span class="text-green-600 font-semibold">—</span>`;

          const row = document.createElement("tr");
          row.className = "hover:bg-gray-50 border-b";

          row.innerHTML = `
        <td class="p-4 font-bold">${index + 1}</td>
        <td class="p-4 ${decisionColor}">${item.decision.toUpperCase()}</td>
        <td class="p-4">${item.score_percent} %</td>
        <td class="p-4">
            <details class="bg-gray-50 p-2 rounded">
                <summary class="cursor-pointer text-blue-700 font-semibold">
                    Voir les détails
                </summary>
                <ul class="mt-2 text-gray-700 text-xs space-y-1">
                    ${inputsList}
                </ul>
            </details>
        </td>
        <td class="p-4">
            ${negatives}
        </td>
      `;

          tbody.appendChild(row);
        });
      }

      loadHistory();
    </script>
  </body>
</html>
